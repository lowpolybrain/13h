{"version":3,"file":"index.js","sources":["../../classes/Image.ts","../../classes/FixedSprite.ts"],"sourcesContent":["import { makeListener, Canvas, Point, PointArg, point } from '@13h/core';\n\nexport type ImageOptions = {\n  crossOrigin: boolean;\n};\n\nexport class Image {\n  private _isReady: boolean = false;\n  public element: HTMLImageElement;\n\n  private _size: Point;\n  private _center: Point;\n  private _pivot: Point = [0, 0];\n\n  public get pivot(): Point {\n    return this._pivot;\n  }\n\n  public get size(): Point {\n    return this._size;\n  }\n\n  public get height(): number {\n    return this._size[1];\n  }\n  public get width(): number {\n    return this._size[0];\n  }\n  public get cx(): number {\n    return this._size[0] / 2;\n  }\n  public get cy(): number {\n    return this._size[1] / 2;\n  }\n  public get center(): Point {\n    return this._center;\n  }\n\n  public setSize([width, height]: Point): this {\n    this._size = [width, height];\n    this._center = [width / 2, height / 2];\n    this.element.width = width;\n    this.element.height = height;\n    return this;\n  }\n\n  get isReady(): boolean {\n    return this._isReady;\n  }\n  onLoad = makeListener<[Image]>(true, true);\n\n  constructor(private url: string, options: Partial<ImageOptions> = {}) {\n    this.element = document.createElement('img');\n    this.element.src = url;\n    if (options.crossOrigin || options.crossOrigin === undefined) {\n      this.element.crossOrigin = 'Anonymous';\n    }\n    this.element.addEventListener('load', () => {\n      this._isReady = true;\n      const { width, height } = this.element;\n      this._size = [width, height];\n      this._center = [width / 2, height / 2];\n      this.onLoad.fire(this);\n    });\n  }\n\n  draw(destination: Canvas, [x, y]: Point = [0, 0], rotation?: number, scale: PointArg = 1, alpha: number = 1) {\n    const scl = point.get(scale);\n    // TODO: Take smoothing into account\n    destination.context.save();\n    const [px, py] = this.pivot;\n    destination.context.globalAlpha = alpha;\n    if (!rotation && !scl && !rotation) {\n      destination.context.drawImage(this.element, x - px, y - py);\n    } else {\n      if (x || y) {\n        destination.context.translate(x, y);\n      }\n      if (rotation) {\n        destination.context.rotate(rotation);\n      }\n      if (scl) {\n        destination.context.scale(scl[0], scl[1]);\n      }\n      destination.context.translate(-px, -py);\n      destination.context.drawImage(this.element, 0, 0);\n      // destination.context.setTransform(1, 0, 0, 1, 0, 0); // TODO: Is this needed?\n      // TODO: Maybe, use setTransform for translate/rotate/scl\n    }\n    destination.context.restore();\n    return this;\n  }\n\n  createCanvas(cropStart?: PointArg, cropEnd?: PointArg): Canvas {\n    const [sx, sy] = point.get(cropStart);\n    const [ex, ey] = point.get(cropEnd, this.size);\n    const canvas = new Canvas([ex - sx, ey - sy]);\n    canvas.context.drawImage(this.element, -sx, -sy); // TODO: Benchmark fastest way of doing this\n    return canvas;\n  }\n}\n","import { point, Point, Canvas, PointArg } from '@13h/core';\nimport { Image } from './Image';\n\nexport class FixedSprite {\n  private size: Point;\n  private _sprite: Canvas;\n  private spriteIndex: number = 0;\n\n  constructor(private image: Image | Canvas, size: PointArg, private spriteNum?: Point) {\n    this.size = point.get(size);\n    this._sprite = new Canvas(size);\n    this.setSpriteIndex(0);\n  }\n\n  public setSpriteIndex(index: number): this {\n    this.spriteIndex = index;\n    this._sprite.clear();\n\n    const [nx, ny] = this.getSpriteNum();\n    const max = nx * ny;\n    if (index < max && index >= 0) {\n      const [xs, ys] = this.size;\n      const xi = index % nx;\n      const yi = Math.floor(index / nx);\n      this._sprite.context.drawImage(this.image.element, -xi * xs, -yi * ys);\n    }\n    return this;\n  }\n\n  public get lastFrameIndex(): number {\n    const [nx, ny] = this.getSpriteNum();\n    return nx * ny - 1;\n  }\n\n  public nextSprite(): this {\n    const nextSpriteIndex = (this.spriteIndex + 1) % this.lastFrameIndex;\n    this.setSpriteIndex(nextSpriteIndex);\n    return this;\n  }\n\n  public draw(destination: Canvas, pos?: Point, rotation?: number, scale?: PointArg, alpha?: number): this {\n    this._sprite.draw(destination, pos, rotation, scale, alpha);\n    return this;\n  }\n\n  private getSpriteNum(): Point {\n    if (this.spriteNum) {\n      return this.spriteNum;\n    }\n    const [w, h] = this.image.size;\n\n    return [Math.floor(w / this.size[0]), Math.floor(h / this.size[1])];\n  }\n\n  public getDebugCanvas(): Canvas {\n    const debugCanvas = this.image instanceof Canvas ? this.image.copy() : this.image.createCanvas();\n\n    const [sx, sy] = this.size;\n\n    const [nx, ny] = this.getSpriteNum();\n    const w = sx * nx;\n    const h = sy * ny;\n\n    for (let ix = 0; ix <= nx; ix += 1) {\n      const x = ix * sx;\n      debugCanvas.line([x - 0.5, 0], [x - 0.5, h], '#0f05', 1);\n      debugCanvas.line([x + 0.5, 0], [x + 0.5, h], '#f005', 1);\n    }\n    for (let iy = 0; iy <= ny; iy += 1) {\n      const y = iy * sy;\n      debugCanvas.line([0, y - 0.5], [w, y + 0.5], '#ff05', 1);\n      debugCanvas.line([0, y + 0.5], [w, y + 0.5], '#00f5', 1);\n    }\n\n    debugCanvas.text(nx + 'x' + ny, [3, 3], '#000');\n    debugCanvas.text(nx + 'x' + ny, [2.5, 2.5], '#fff');\n\n    return debugCanvas;\n  }\n}\n"],"names":["makeListener","point","Canvas"],"mappings":"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"}